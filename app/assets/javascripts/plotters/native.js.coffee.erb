class NmdPlot.Plotters.Native extends NmdPlot.Plotters.Base



  populateNavList: ()->
    # sort backgrounds by name
    for backgroundId in @sortedIds(@tmpGroups, @backgroundSorter)
      $background = $("<div class='background-name'>").html(@getBackground(backgroundId))
      $(".nav-list .items").append($background)

      # cumulate studentIds for background
      studentIdsForBackground = []
      for placeId, studentIds of @currentGroups[backgroundId]
        studentIdsForBackground = studentIdsForBackground.concat(studentIds)

      # sort students by name
      for studentId in studentIdsForBackground.sort(@studentSorter)
        studentId  = studentId
        student    = @getStudent(studentId)

        $itemLabel = $("<span>")
          .attr(id: "group-label-#{studentId}")
          .html(student.name)
          .data("group-id", studentId)

        $item = $("<div>").addClass("item").append($itemLabel)

        if student.website?
          $itemLink  = $("<a>")
            .attr(
              href: student.website
              target: "_blank"
            ).html("<img src='<%= asset_path('arrow.png') %>'/>")
          $item.append($itemLink)


        $itemLabel.click @labelOnClick
        $(".nav-list .items").append($item)


  labelOnClick: (event)=>
    groupId   = $(event.target).data("group-id")
    $(".item").removeClass("selected-item")
    $(event.target).parent().addClass("selected-item")

    @mapView.map.setDefaultIconOnMarkers(@previousMarkerIds)
    for placeId, studentIds of @currentGroups[groupId]
      @map.highlightMarker("group-#{groupId}-#{placeId}")
      @previousMarkerIds.push "group-#{groupId}-#{placeId}"


  createMarker: (studentIds, opts) ->
    markup = ""

    for studentId in studentIds
      student = @getStudent(studentId)
      markup += """
        <div class="student">
          <div class='student_name'>#{student.name}</div>
        </div>
      """
    opts['weight'] = studentIds.length
    @mapView.map.createMarker markup, opts


  groupData: ->
    for studentId, student of @data.students
      if !@currentGroups[student.background_id]
        @currentGroups[student.background_id] = {}

      if !@currentGroups[student.background_id][student.place_id]
        @currentGroups[student.background_id][student.place_id] = []
        @addPlace(student.place_id)

      @currentGroups[student.background_id][student.place_id].push(studentId)

    @tmpGroups = @currentGroups


  # Trying to filter using currentGroups would be a nightmare for cleaning up data
  filterGroups: (string)->
    for studentId, student of @data.students
      continue if !student.name.match(new RegExp(string, "gi"))

      if !@tmpGroups[student.background_id]
        @tmpGroups[student.background_id] = {}

      if !@tmpGroups[student.background_id][student.place_id]
        @tmpGroups[student.background_id][student.place_id] = []
        @addPlace(student.place_id)

      @tmpGroups[student.background_id][student.place_id].push(studentId)



  plot: (options={})->
    @resetState(options)

    if !options.filterPlot
      @groupData()
    else
      @filterGroups(options.filterString)

    for backgroundId, placeGroups of @tmpGroups
      for placeId, studentIds of placeGroups
        for studentId in studentIds
          @getPlace(placeId).name
          marker = @createMarker(
            studentIds,
            lat: @getPlace(placeId).latitude
            lng: @getPlace(placeId).longitude
            labelId:   "group-label-#{studentId}"
          )

    @populateNavList()
